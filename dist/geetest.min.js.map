{"version":3,"file":"geetest.min.js","sources":["../src/geetest.jsx"],"sourcesContent":["import React from 'react';\n\nconst SCRIPT_ID = 'react-geetest';\n\nconst typeOf = type => object => Object.prototype.toString.call(object) === `[object ${type}]`;\n\n// const isString = typeOf('String');\n// const isObject = typeOf('Object');\nconst isFunction = typeOf('Function');\n\nexport default class NECaptcha extends React.Component {\n  static defaultProps = {\n    className: 'i-geetest',\n    // gt: '',\n    // challenge: '',\n    offline: false,\n    newCaptcha: true,\n    product: 'popup',\n    width: '300px',\n    lang: 'zh-cn',\n    https: false,\n    timeout: 30000,\n    // area: '',\n    nextWidth: '90%',\n    bgColor: 'black',\n    onReady: () => {},\n    onSuccess: () => {},\n    onError: () => {},\n    onClose: () => {},\n  };\n\n  constructor(props) {\n    super(props);\n    this.dom = null;\n    this.state = {\n      ins: null,\n      script: null,\n      elem: null,\n    };\n  }\n\n  // componentWillMount() {\n  //   const that = this;\n  //   console.log('componentWillMount', that.props, that.state);\n  // }\n\n  componentDidMount() {\n    const that = this;\n    // console.log('componentDidMount', that.props, that.state);\n    that.init();\n  }\n\n  // componentWillReceiveProps(nextProps) {\n  //   const that = this;\n  //   console.log('componentWillReceiveProps', that.props, nextProps);\n  // }\n\n  shouldComponentUpdate(nextProps, nextState) {\n    const that = this;\n    // console.log('shouldComponentUpdate', that.props, nextProps, that.state, nextState);\n    const {\n      className,\n      gt,\n      challenge,\n      offline,\n      newCaptcha,\n      product,\n      width,\n      lang,\n      https,\n      timeout,\n      area,\n      nextWidth,\n      bgColor,\n    } = that.props;\n\n    const isUpdate =\n      className !== nextProps.className ||\n      gt !== nextProps.gt ||\n      challenge !== nextProps.challenge ||\n      offline !== nextProps.offline ||\n      newCaptcha !== nextProps.newCaptcha ||\n      product !== nextProps.product ||\n      width !== nextProps.width ||\n      lang !== nextProps.lang ||\n      https !== nextProps.https ||\n      timeout !== nextProps.timeout ||\n      area !== nextProps.area ||\n      nextWidth !== nextProps.nextWidth ||\n      bgColor !== nextProps.bgColor;\n\n    return isUpdate;\n  }\n\n  // componentWillUpdate(nextProps, nextState) {\n  //   const that = this;\n  //   console.log('componentWillUpdate', that.props, nextProps, that.state, nextState);\n  // }\n\n  componentDidUpdate(prevProps, prevState) {\n    const that = this;\n    // console.log('componentDidUpdate', prevProps, that.props, prevState, that.state);\n    that.init();\n  }\n\n  componentWillUnmount() {\n    const that = this;\n    // console.log('componentWillUnmount', that.props, that.state);\n    that.destroy();\n  }\n\n  init = () => {\n    const that = this;\n    // console.log('init');\n    const { elem } = that.state;\n\n    if (window.initGeetest) {\n      that.ready();\n      return;\n    }\n\n    const script = document.getElementById(SCRIPT_ID);\n    if (script) {\n      if (elem) {\n        return;\n      }\n\n      script.addEventListener('Im-ready', that.ready.bind(that), false);\n      that.setState({\n        elem: script,\n      });\n      return;\n    }\n\n    const ds = document.createElement('script');\n    ds.id = SCRIPT_ID;\n    ds.type = 'text/javascript';\n    ds.async = true;\n    ds.charset = 'utf-8';\n\n    if (ds.readyState) {\n      ds.onreadystatechange = () => {\n        if (ds.readyState === 'loaded' || ds.readyState === 'complete') {\n          ds.onreadystatechange = null;\n          that.ready();\n          that.triggerEvent('Im-ready');\n        }\n      };\n    } else {\n      ds.onload = () => {\n        ds.onload = null;\n        that.ready();\n        that.triggerEvent('Im-ready');\n      };\n    }\n\n    const protocol = window.location.protocol === 'http:' ? 'http:' : 'https:';\n    ds.src = `${protocol}//static.geetest.com/static/tools/gt.js?_t=${new Date().getTime()}`;\n    const s = document.getElementsByTagName('script')[0];\n    s.parentNode.insertBefore(ds, s);\n\n    that.setState({\n      script: ds,\n    });\n  };\n\n  ready = event => {\n    const that = this;\n    // console.log('_ready');\n    const {\n      gt,\n      challenge,\n      offline,\n      newCaptcha,\n      product,\n      width,\n      lang,\n      https,\n      timeout,\n      area,\n      nextWidth,\n      bgColor,\n    } = that.props;\n    const { ins, elem } = that.state;\n\n    if (!window.initGeetest) {\n      return;\n    }\n\n    if (ins) {\n      that.load(ins);\n      return;\n    }\n\n    window.initGeetest(\n      {\n        gt,\n        challenge,\n        offline,\n        new_captcha: newCaptcha,\n        product,\n        width,\n        lang,\n        https,\n        timeout,\n        area,\n        next_width: nextWidth,\n        bg_color: bgColor,\n      },\n      geetest => {\n        that.load(geetest);\n\n        that.setState({\n          ins: geetest,\n        });\n      }\n    );\n\n    if (elem) {\n      elem.removeEventListener('Im-ready', that.ready.bind(that), false);\n    }\n  };\n\n  load = ins => {\n    const that = this;\n    // console.log('load');\n\n    if (!that.dom) {\n      return;\n    }\n\n    const { onReady, onSuccess, onError, onClose } = that.props;\n\n    ins.appendTo(that.dom);\n\n    if (isFunction(ins.onReady)) {\n      ins.onReady((...arg) => onReady(...arg, ins));\n    }\n\n    ins.onSuccess(() => onSuccess(ins.getValidate(), ins));\n\n    if (isFunction(ins.onError)) {\n      ins.onError((...arg) => onError(...arg, ins));\n    }\n\n    if (isFunction(ins.onClose)) {\n      ins.onClose((...arg) => onClose(...arg, ins));\n    }\n  };\n\n  destroy = () => {\n    const that = this;\n    // console.log('destroy');\n    const { elem } = that.state;\n\n    if (elem) {\n      elem.removeEventListener('Im-ready', that.ready.bind(that), false);\n    }\n\n    // script.parentNode.removeChild(that.state.script);\n\n    // that.setState({\n    //   ins: null,\n    //   script: null,\n    //   elem: null,\n    // });\n  };\n\n  triggerEvent = name => {\n    const that = this;\n    // console.log('triggerEvent');\n    const { elem, script } = that.state;\n\n    if (!elem && !script) {\n      return;\n    }\n\n    const e = document.createEvent('Event');\n    e.initEvent(name, true, true);\n\n    const dom = elem || script;\n    dom.dispatchEvent(e);\n  };\n\n  render() {\n    const that = this;\n    // console.log('render');\n    const { className } = that.props;\n\n    return (\n      <div\n        className={className}\n        ref={e => {\n          that.dom = e;\n        }}\n      />\n    );\n  }\n}\n"],"names":["type","SCRIPT_ID","isFunction","object","Object","prototype","toString","call","NECaptcha","props","that","elem","state","window","initGeetest","ready","script","document","getElementById","addEventListener","bind","setState","ds","createElement","id","async","charset","readyState","onreadystatechange","triggerEvent","onload","protocol","location","src","Date","getTime","s","getElementsByTagName","parentNode","insertBefore","event","gt","challenge","offline","newCaptcha","product","width","lang","https","timeout","area","nextWidth","bgColor","ins","load","new_captcha","next_width","bg_color","geetest","removeEventListener","dom","onReady","onSuccess","onError","onClose","appendTo","arg","getValidate","name","e","createEvent","initEvent","dispatchEvent","React","Component","this","init","nextProps","nextState","className","prevProps","prevState","destroy","ref"],"mappings":"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"}